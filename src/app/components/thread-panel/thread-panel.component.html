<div class="thread-panel">
  <div class="panel-header">
    <h2 class="panel-title">{{ i18n.t.content.title }}</h2>
    
    <!-- Adhoc Content Button -->
    <button class="btn btn-ghost btn-sm adhoc-btn" (click)="showAdhocModal.set(true)" title="{{ i18n.t.adhoc.button }}">
      üìé {{ i18n.t.adhoc.button }}
    </button>
    <!-- Platform tabs when content is generated -->
    @if (hasAnyContent()) {
    <div class="platform-tabs">
      @for (platform of getSelectedPlatforms(); track platform) {
      <button class="platform-tab" [class.active]="activePlatformTab() === platform && !showMediaTab()"
        (click)="setActivePlatformTab(platform); showMediaTab.set(false)">
        {{ getPlatformIcon(platform) }} {{ getPlatformName(platform) }}
      </button>
      }
      <!-- Media Tab -->
      <button class="platform-tab media-tab" [class.active]="showMediaTab()" (click)="showMediaTab.set(true)">
        üé® {{ i18n.t.media.tabTitle }}
      </button>
    </div>
    }
  </div>

  <div class="panel-content">
    @if (isGenerating()) {
    <div class="generating-state">
      <div class="generating-spinner"></div>
      <p>{{ i18n.t.content.generatingOptimized }}</p>
      <p class="generating-hint">{{ i18n.t.content.generatingHint }}</p>
    </div>
    } @else if (error()) {
    <div class="error-state">
      <span class="error-icon">‚ö†Ô∏è</span>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="generateContent()">Try again</button>
      </div>
      } @else if (showMediaTab() && hasAnyContent()) {
      <!-- Media Assets Tab Content -->
      <div class="media-assets-container">
        <div class="media-assets-header">
          <h3>üé® {{ i18n.t.media.assetsTitle }}</h3>
          <div class="thread-actions">
            <button class="btn btn-ghost" (click)="clearAllContent()">
              ‚úï {{ i18n.t.common.close }}
            </button>
          </div>
          </div>
        <p class="linkedin-hint">üí° {{ i18n.t.media.linkedinHint }}</p>
      
        <!-- Original Feed Media -->
        @if (getOriginalMedia().length > 0) {
        <div class="media-section-group">
          <h4 class="section-title">üìé {{ i18n.t.common.originalMedia || 'Original Media' }}</h4>
          <div class="media-grid">
            @for (media of getOriginalMedia(); track $index) {
            <div class="media-asset-card original">
              <div class="asset-badge">Original</div>
              @if (media.type === 'image') {
              <img [src]="media.url" alt="Original media" class="media-preview" />
              } @else {
              <video [src]="media.url" controls class="media-preview"></video>
              }
              <div class="asset-info">
                <span class="asset-source">{{ media.source }}</span>
              </div>
              <button class="btn btn-sm btn-secondary" (click)="downloadOriginalMedia(media)">
                ‚¨áÔ∏è Download
              </button>
            </div>
            }
          </div>
        </div>
        }
      </div>
      } @else if (hasPlatformContent(activePlatformTab()) && !showMediaTab()) {
    <div class="thread-container">
      <!-- Twitter Content -->
      @if (activePlatformTab() === 'twitter' && thread()) {
      <div class="thread-header">
        <span class="tweet-count">{{ thread()!.tweets.length }} tweets</span>
        <div class="thread-actions">
          <button class="btn btn-secondary" (click)="copyThread()" [class.copied]="copiedIndex() === -1">
            {{ copiedIndex() === -1 ? '‚úì ' + i18n.t.content.copied : 'üìã ' + i18n.t.content.copyToClipboard }}
          </button>
          <button class="btn btn-ghost" (click)="clearThread()">
            ‚úï {{ i18n.t.common.close }}
          </button>
        </div>
      </div>

      <div class="tweets-list">
        @for (tweet of thread()!.tweets; track tweet.index) {
        <article class="tweet-card">
          <div class="tweet-header">
            <span class="tweet-number">{{ tweet.index }}/{{ thread()!.tweets.length }}</span>
            <span class="char-count" [class]="getCharCountClass(getCharCount(tweet.content))">
              {{ getCharCount(tweet.content) }}/280
            </span>
          </div>

          <p class="tweet-content">{{ tweet.content }}</p>

          @if (tweet.mediaPlaceholder) {
          <div class="media-section">
            @if (getGeneratedMedia(tweet.index); as media) {
            <div class="generated-media">
              @if (media.type === 'image') {
              <img [src]="'data:' + media.mimeType + ';base64,' + media.data" alt="Generated image"
                class="generated-image" />
              } @else {
              <video [src]="media.url" controls class="generated-video"></video>
              }
              <div class="media-actions">
                <button class="btn btn-sm btn-secondary" (click)="downloadMedia(media, tweet.index)">
                  ‚¨áÔ∏è Download
                </button>
                <button class="btn btn-sm btn-ghost" (click)="clearGeneratedMedia(tweet.index)"
                  [title]="i18n.t.content.regenerateMedia">
                  üîÑ {{ i18n.t.content.regenerate }}
                </button>
              </div>
            </div>
            } @else {
            <div class="media-placeholder">
              <div class="media-header">
                <span class="media-icon">{{ getMediaIcon(tweet.mediaPlaceholder.type) }}</span>
                <span class="media-type">{{ tweet.mediaPlaceholder.type === 'image' ? i18n.t.common.image :
                  i18n.t.common.video }}</span>
                <span class="media-tool">via {{ getToolLabel(tweet.mediaPlaceholder.tool) }}</span>
              </div>
              <p class="media-prompt">
                <strong>Prompt:</strong> {{ tweet.mediaPlaceholder.prompt }}
              </p>

              @if (isGeneratingMedia(tweet.index)) {
              <div class="media-generating">
                <div class="generating-spinner small"></div>
                <span>{{ mediaProgress() }}</span>
              </div>
              } @else {
              <button class="btn btn-primary btn-sm" (click)="generateMedia(tweet)">
                ‚ú® {{ i18n.t.content.generate }} {{ tweet.mediaPlaceholder.type === 'image' ? i18n.t.common.image :
                i18n.t.common.video }}
              </button>
              }
              </div>
            }
            </div>
            }

          <div class="tweet-actions">
            <button class="btn btn-ghost btn-sm" (click)="copyTweet(tweet)" [class.copied]="copiedIndex() === tweet.index">
              {{ copiedIndex() === tweet.index ? '‚úì' : 'üìã' }}
            </button>
            <button class="btn btn-ghost btn-sm" (click)="regenerateTweet(tweet.index)" title="Regenerate">
              üîÑ
            </button>
          </div>
          </article>
          }
          </div>
          }
          
          <!-- LinkedIn/Threads/BlueSky Content -->
          @if (activePlatformTab() !== 'twitter' && getPlatformContent(activePlatformTab()); as platformContent) {
          <div class="thread-header">
            <span class="tweet-count">{{ platformContent.posts.length }} {{ activePlatformTab() === 'linkedin' ? 'posts' :
              i18n.t.content.post + 's' }}</span>
            <div class="thread-actions">
              <button class="btn btn-secondary" (click)="copyPlatformContent()" [class.copied]="copiedIndex() === -1">
                {{ copiedIndex() === -1 ? '‚úì ' + i18n.t.content.copied : 'üìã ' + i18n.t.content.copyToClipboard }}
              </button>
              <button class="btn btn-ghost" (click)="clearAllContent()">
                ‚úï {{ i18n.t.common.close }}
              </button>
            </div>
          </div>
          
          <div class="tweets-list">
            @for (post of platformContent.posts; track $index) {
            <article class="tweet-card" [class.comment-card]="post.isComment">
              <div class="tweet-header">
                <span class="tweet-number">{{ $index + 1 }}/{{ platformContent.posts.length }}</span>
                @if (post.isComment) {
                <span class="post-type-badge">üí¨ {{ i18n.t.content.comment }}</span>
                }
                <span class="char-count" [class]="getCharCountClass(getCharCount(post.text))">
                  {{ getCharCount(post.text) }}/{{ platforms[activePlatformTab()].maxChars }}
                </span>
              </div>
          
              <p class="tweet-content">{{ post.text }}</p>
          
              @if (post.linkReference) {
              <div class="link-reference">
                <span class="link-icon">üîó</span>
                <a [href]="post.linkReference" target="_blank" class="link-url">{{ post.linkReference }}</a>
              </div>
              }
          
              @if (post.mediaPlaceholder) {
              <div class="media-section">
                <!-- Show generated media if available -->
                @if (getGeneratedMediaForPlatform(activePlatformTab(), $index); as media) {
                <div class="generated-media">
                  @if (media.type === 'image') {
                  <img [src]="'data:' + media.mimeType + ';base64,' + media.data" alt="Generated image" class="generated-image" />
                  } @else {
                  <video [src]="media.url" controls class="generated-video"></video>
                  }
                  <div class="media-actions">
                    <button class="btn btn-sm btn-secondary"
                      (click)="downloadMediaForPlatform(media, activePlatformTab(), $index)">
                      ‚¨áÔ∏è Download
                    </button>
                    <button class="btn btn-sm btn-ghost" (click)="clearGeneratedMediaForPlatform(activePlatformTab(), $index)"
                      [title]="i18n.t.content.regenerateMedia">
                      üîÑ {{ i18n.t.content.regenerate }}
                    </button>
                  </div>
                </div>
                } @else {
                <!-- Show placeholder and generate button -->
                <div class="media-placeholder">
                  <div class="media-header">
                    <span class="media-icon">üñºÔ∏è</span>
                    <span class="media-type">{{ i18n.t.common.image }}</span>
                    <span class="media-tool">via Nano Banana</span>
                  </div>
          
                  <p class="media-prompt">
                    <strong>Prompt:</strong> {{ post.mediaPlaceholder }}
                  </p>
          
                  @if (isGeneratingMediaForPlatform(activePlatformTab(), $index)) {
                  <div class="media-generating">
                    <div class="generating-spinner small"></div>
                    <span>{{ mediaProgress() }}</span>
                  </div>
                  } @else {
                  <button class="btn btn-primary btn-sm" (click)="generateMediaForPlatform(post, activePlatformTab(), $index)">
                    ‚ú® {{ i18n.t.content.generate }} {{ i18n.t.common.image }}
                  </button>
                  }
                </div>
                }
              </div>
              }
          
              <div class="tweet-actions">
                <button class="btn btn-ghost btn-sm" (click)="copyPostText(post.text, $index)"
                  [class.copied]="copiedIndex() === $index">
                  {{ copiedIndex() === $index ? '‚úì' : 'üìã' }}
                </button>
              </div>
            </article>
            }
          </div>
          }
    </div>
    } @else {
    <div class="empty-state">
      <div class="empty-icon">üí¨</div>
      <h3>{{ i18n.t.content.noContent }}</h3>
      <p>{{ i18n.t.content.selectItems }}</p>

      @if (selectedCount() === 0) {
      <p class="hint">{{ i18n.t.feed.selectToGenerate }}</p>
      }
    </div>
    }
  </div>

  @if (!isGenerating() && !thread() && selectedCount() > 0) {
  <div class="panel-footer">
    <!-- Additional URLs section -->
    <div class="url-context-section">
      <button class="btn btn-ghost btn-sm" (click)="toggleUrlInput()">
        üîó {{ showUrlInput() ? i18n.t.common.close : i18n.t.content.urlContext }}
      </button>

      @if (showUrlInput()) {
      <div class="url-input-container">
        <textarea class="url-input" [value]="additionalUrls()" (input)="updateAdditionalUrls($event)"
          [placeholder]="i18n.t.content.urlPlaceholder" rows="3"></textarea>
        <p class="url-hint">{{ i18n.t.content.urlHint }}</p>
      </div>
      }
    </div>

    <!-- Platform selector dropdown -->
    <div class="platform-selector">
      <button class="btn btn-secondary platform-dropdown-btn" (click)="togglePlatformDropdown()">
        {{ i18n.t.content.selectPlatforms }}
        <span class="platform-count">({{ getSelectedPlatformCount() }})</span>
        <span class="dropdown-arrow">‚ñº</span>
      </button>
      
      @if (showPlatformDropdown()) {
      <div class="platform-dropdown">
        @for (platform of platformList; track platform) {
        <label class="platform-option" (click)="$event.stopPropagation()">
          <input type="checkbox" 
            [checked]="isPlatformSelected(platform)"
            (change)="togglePlatform(platform)" />
          <span class="platform-icon">{{ getPlatformIcon(platform) }}</span>
          <span class="platform-name">{{ getPlatformName(platform) }}</span>
        </label>
        }
      </div>
      }
    </div>

    <button class="btn btn-primary btn-full generate-btn" (click)="generateContent()"
      [disabled]="getSelectedPlatformCount() === 0">
      <span class="btn-icon">‚ú®</span>
      {{ i18n.t.content.generateContent }} ({{ selectedCount() }} items)
    </button>
    @if (getSelectedPlatformCount() === 0) {
    <p class="platform-warning">{{ i18n.t.platforms.selectAtLeastOne }}</p>
    }
  </div>
  }
<!-- Adhoc Content Modal -->
@if (showAdhocModal()) {
<div class="adhoc-modal-overlay" (click)="closeAdhocModal()">
  <div class="adhoc-modal" (click)="$event.stopPropagation()">
    <div class="adhoc-modal-header">
      <h3>üìé {{ i18n.t.adhoc.title }}</h3>
      <button class="btn btn-ghost btn-sm" (click)="closeAdhocModal()">‚úï</button>
    </div>

    <div class="adhoc-modal-content">
      <!-- URL Input -->
      <div class="adhoc-field">
        <label>üîó URL</label>
        <input type="text" class="adhoc-input" [value]="adhocUrl()" (input)="adhocUrl.set($any($event.target).value)"
          [placeholder]="i18n.t.adhoc.urlPlaceholder" />
      </div>

      <!-- Image Upload -->
      <div class="adhoc-field">
        <label>üñºÔ∏è {{ i18n.t.adhoc.uploadImage }}</label>
        <div class="adhoc-dropzone" (click)="adhocFileInput.click()" (dragover)="$event.preventDefault()"
          (drop)="onAdhocImageDrop($event)">
          @if (adhocImagePreview()) {
          <img [src]="adhocImagePreview()" alt="Preview" class="adhoc-image-preview" />
          <button class="btn btn-ghost btn-sm remove-image"
            (click)="clearAdhocImage(); $event.stopPropagation()">‚úï</button>
          } @else {
          <span class="dropzone-text">{{ i18n.t.adhoc.dropImage }}</span>
          }
        </div>
        <input type="file" #adhocFileInput accept="image/*" (change)="onAdhocImageSelect($event)"
          style="display: none" />
      </div>

      <!-- Error Message -->
      @if (adhocError()) {
      <div class="adhoc-error">
        ‚ö†Ô∏è {{ adhocError() }}
      </div>
      }
    </div>

    <div class="adhoc-modal-footer">
      <button class="btn btn-secondary" (click)="closeAdhocModal()">{{ i18n.t.common.cancel }}</button>
      <button class="btn btn-primary" (click)="generateAdhocContent()" [disabled]="adhocLoading()">
        @if (adhocLoading()) {
        <span class="spinner-small"></span>
        {{ i18n.t.adhoc.processing }}
        } @else {
        ‚ú® {{ i18n.t.adhoc.generate }}
        }
      </button>
    </div>
  </div>
</div>
}
</div>